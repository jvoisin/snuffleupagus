language: php

before_install:
  - pip install --user cpp-coveralls
  - if test ${TARGET} = "coverity"; then echo -n | openssl s_client -connect scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-; fi


env:
  - secure: "fjx/arfcdoqWUIzlQXzQdW9gqXRG7Vpo8dTwJip0uJH8oFeTfYhw1V9EMS4JtKVGwQo3vaagehMflVr7swaoe9Nf4YoCjaEq8x6ZMJH3bLHNgtigfS03Uqop9FI/a/Jau/BL7ibIEkZRNfEIx8z+NyfY4bAeK35W/Ru5k2BHyp1GLKwBpizHdJsshG/ukM+4W8PY9BAeXVavqxQRywseQEsqmGruGLcYFuuh04D7cnNqyuYgbdaq7YMKZfVGxM7N5eeL5xSlw0Sl9yOutRzkxUmL1WSmYMFrkRLcc37hRTu67tCmP60tiGLGY2Ll8nUh6rkc3RwBgc1wOC7jRMrtoGvlgsLxz7kLOtpQ31PdJKefe99rQMkcYKLwCxXf7WQdOHY4YsTmjqlPyzfTKT3mNtGhUwp1rEvlcygZZK8osHtc46BUD6BKNRCvTyLNyLTx2IoA4WfrzWOaQ+A1gNRD5L9Jbqi0kY6teENCzzlHUe80mH7wBarCTRoDAD73w/EPgSn3+CeLALXXEu+r9Sm/e5YpaFfLdeKDC6fr1KwU69ddHUKWZqjFM8vEHjrIbmAdNwVsuCo8LeWdCCXdQlWrISQ4OUDBBEmnwlKoojSjIYP5SKoH1txZemGok1/TN/tvjlyrx2RYYxy7AdUulENKXXeqlwWsiwVZCZLR4tt+wEQ="

matrix:
  include:
  - env: TARGET="ASAN" CC="clang" CFLAGS="-fsanitize=address" LDFLAGS="-lasan"
    php: '7.0'

script:
  - cd src
  - phpize
  - ./configure --enable-snuffleupagus --enable-coverage
  - make -j 2
  - TEST_PHP_ARGS='-q' REPORT_EXIT_STATUS=1 make test

after_success:
  - 'if [ ${CC} = "gcc" ]; then
      git clone https://github.com/linux-test-project/lcov.git --depth 1 ;
      rm -rf ./lcov/examples/ ./lcov/test/ ;
      ./lcov/bin/lcov -c -o ./COV.info --rc lcov_branch_coverage=1 --base-directory . --directory . ;
      ./lcov/bin/lcov --remove ./COV.info "/usr/*" --remove ./COV.info "*tweetnacl.c" -o ./COV.info --rc lcov_branch_coverage=1 ;
      ./lcov/bin/genhtml -o ./COV.html ./COV.info  --branch-coverage ;
      coveralls --exclude "tweetnacl.c" ;
    fi'

after_failure:
  - grep -r . ./tests/*.out
  - grep -r . ./tests/*.diff
